<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lmsltirollcallsjtu.common.dao.CombineAttendancesDao">

    <!--根据课程编号查询签到历史列表-->
	<select id="queryUsersStatesByIds" parameterType="java.util.List" resultType="com.lmsltirollcallsjtu.common.bean.bo.UsersCombine">
		select
			r.user_code,
			r.user_name,
			h.course_code,
			h.section_list sectionListJsonStr,
			h.total_students,
			h.exp_attendances_count,
			h.is_valid,
			h.created_by,
			r.state,
			r.section_name,
			r.created_date
		from sign_records r
		inner join sign_histories h on h.id=r.rollcall_code
		where 1 = 1
		<if test="ids != null and ids.size() > 0" >
			and h.id in
			<foreach collection="ids" item="item" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		order by r.user_code desc,r.created_date desc
	</select>

	<insert id="combineInsertSignHistoryBySignHistory" parameterType="com.lmsltirollcallsjtu.common.bean.bo.SignHistory">
		insert into sign_histories
		(
		id,
		course_code,
		user_code,
		section_list ,
		attendances_count,
		exp_attendances_count,
		created_by
		)
		values
		(
		#{id},
		#{courseCode},
		#{userCode},
		#{sectionListJsonStr},
		#{attendancesCount},
		#{expAttendancesCount},
		#{createdBy}
		)
	</insert>
	<insert id="combineInsertSignRecordBySignRecordsInfo" parameterType="java.util.List">
		insert into sign_records
		(
		id,
		user_code,
		rollcall_code,
		open_id,
		state,
		user_name,
		section_name,
		created_by
		)
		values
		<foreach collection="signRecordsBo" item="item" separator=",">
			(
			#{item.id},
			#{item.userCode},
			#{item.rollcallCode},
			#{item.openId},
			#{item.state},
			#{item.userName},
			#{item.sectionName},
			#{item.createdBy}
			)
		</foreach>
	</insert>

</mapper>